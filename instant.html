<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>n8n</title>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, system-ui, sans-serif;
            background: #f5f5f5;
        }
        .status {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #4CAF50; }
    </style>
</head>
<body>
    <div class="status">
        <div id="message">Отправка...</div>
    </div>
    
    <script>
        const WEBHOOKS = {
            test: 'https://n8n.wefiftytwo.com/webhook-test/ats-score',
            prod: 'https://n8n.wefiftytwo.com/webhook/ats-score'
        };
        
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'test';
        params.delete('mode');
        
        const url = WEBHOOKS[mode] + '?' + params.toString();
        
        // Method 1: Navigator.sendBeacon (survives page close)
        if (navigator.sendBeacon) {
            const success = navigator.sendBeacon(url);
            console.log('sendBeacon:', success);
        }
        
        // Method 2: Image (also survives page close)
        const img = new Image();
        img.src = url;
        
        // Method 3: Fetch with keepalive
        fetch(url, {
            mode: 'no-cors',
            keepalive: true
        });
        
        // Show success and close after delay
        document.getElementById('message').innerHTML = '<div class="success">✓ Отправлено!</div>';
        
        // Wait 1 second to ensure requests complete
        setTimeout(() => {
            window.close();
            // Fallback if close doesn't work
            window.location.href = 'about:blank';
        }, 1000);
    </script>
</body>
</html>